define(["jquery","util/other"],(function(e,t){function o(o){this.options=t.assignDefaults({form:"#search_form",input:"#search_input",action:"get_main_search",results:"#fast_search_results",autocomplete:".search-autocomplete",overflow:".fast_search_overflow",clear_button:".clear_search_results",no_results:".no_results",clickCallback:"",showNoResults:!0,row:{item:".fast_search_item",text:".fast_search_item_text",link:".fast_search_item_link",selected:".fast_search_focus_item"}},o),this.search_timer=0,this.search_value="",this.results_container=null,this.form=null,this.search_row_index=-1,this.results_container=e(this.options.results).get(0),this.delayed_enter_process=!1;var s=this;this.assignHandlers=function(){e(s.options.input).keyup((function(e){13===e.keyCode||40===e.keyCode||38===e.keyCode||39===e.keyCode||s.processSearch(this)})),e(s.options.input).keydown((function(e){return s.inputKeysActions(this,e)})),e(s.options.form).submit((function(){e(this).find('input[name="verification"]').length&&!e(this).find('input[name="verification_important"]').length&&e(this).find('input[name="verification"]').attr("disabled","disabled");var t=s.search_row_index;return t<0&&(t=0),!e(s.options.row.item,s.form).length||(e(s.options.row.item,s.form).click(),!1)})),e(s.options.input).focus((function(){e(s.options.input).val()&&e(s.results_container).length&&!e(s.results_container).is(":visible")?s.showResults():e(s.options.input).val()&&!e(s.results_container).length&&s.processSearch(this)})),e("body").click((function(t){!s.results_container||e(t.target).is("input")||e(t.target).parents("#search_popup").length||s.hideResults()}))},this.hideResults=function(){e(s.results_container).css("display","none"),"s"!=e(s.options.input).attr("name")||e(s.options.input).val()||e(s.options.clear_button).hide()},this.showResults=function(){e(s.results_container).css("display","block")},this.enterKeyAction=function(t){if(e(s.options.row.item+":eq("+t+") "+s.options.row.link,s.form).attr("href"))window.location.href=e(s.options.row.item+":eq("+t+") "+s.options.row.link,s.form).attr("href");else if(e(s.options.row.item+":eq("+t+") ",s.form).length)e(s.options.row.item+":eq("+t+") ",s.form).click();else if(e(s.form).find('input[name="search_channel_id"]').length){if(!(e(s.form).find('input[name="search_channel_id"]').val()<=0))return!0;s.delayed_enter_process=!0}return!1},this.inputKeysActions=function(o,n){if(s.form||(s.form=e(o).closest("form").get(0)),13===n.keyCode||40===n.keyCode||38===n.keyCode||39===n.keyCode||8===n.keyCode||46===n.keyCode){var i=e(s.options.results+" "+s.options.row.item,s.form).length,r=null;if(8!==n.keyCode&&46!==n.keyCode||e(s.results_container).html(""),13===n.keyCode){var l=s.search_row_index;return l<0&&(l=0),s.enterKeyAction(l)}39===n.keyCode&&e(s.options.autocomplete,s.form).text().length?e(s.options.input,s.form).val(e(s.options.autocomplete,s.form).text()):40===n.keyCode?(e(s.options.results+" "+s.options.row.item,s.form).removeClass(t.clearSelector(s.options.row.selected)),s.search_row_index++,s.search_row_index===i&&(s.search_row_index=0),r=e(s.options.row.item+":eq("+s.search_row_index+")",s.form),e(r).addClass(t.clearSelector(s.options.row.selected))):38===n.keyCode&&(e(s.options.results+" "+s.options.row.item,s.form).removeClass(t.clearSelector(s.options.row.selected)),s.search_row_index--,-1===s.search_row_index&&(s.search_row_index=i-1),r=e(s.options.row.item+":eq("+s.search_row_index+")",s.form),e(r).addClass(t.clearSelector(s.options.row.selected)))}else e(s.options.results+" "+s.options.row.item,s.form).removeClass(t.clearSelector(s.options.row.selected)),s.search_row_index=-1,e(s.options.row.selected).get(0)&&e(s.options.row.selected).html()},this.processSearch=function(o){if(s.form=e(o).closest("form").get(0),e(s.form).find('input[name="search_channel_id"]').length&&e(s.form).find('input[name="search_channel_id"]').val()>0)return!1;s.search_value!=e(o).val()&&(e(s.options.results,s.form).find(s.options.overflow).get(0)||e(s.options.results,s.form).html("<div class='"+t.clearSelector(s.options.overflow)+"'>"+e(s.options.results).html()+"</div>"),s.processFastSearchAutoFill(o),clearTimeout(s.search_timer),s.search_timer=setTimeout((function(){s.makeSearchQuery(e(o).val())}),400),s.search_value=e(o).val(),"s"==e(o).attr("name")&&e(s.options.clear_button).show()),e(o).val().length||s.hideResults()},this.makeSearchQuery=function(o){if("Search"!=o){if(s.results_container||(s.results_container=document.createElement("div"),s.results_container.className=t.clearSelector(s.options.results),s.results_container.id=t.clearSelector(s.options.results),e(s.form).append(s.results_container)),s.results_container.style.borderStyle="none",o.length<2)return s.results_container.style.display="none",!1;e.ajax({url:"ajax_content.php",data:"action="+s.options.action+"&s="+o,type:"POST",dataType:"json",success:function(e){for(;s.results_container.hasChildNodes();)s.results_container.removeChild(s.results_container.lastChild);s.buildSearchElements(e),s.results_container.style.borderStyle="",s.delayed_enter_process&&e.items.length&&s.enterKeyAction(0),s.delayed_enter_process=!1}})}},this.clearSearchResults=function(){return e(s.options.clear_button).hide(),e(s.options.input).val("").keyup().blur(),!1},this.buildRowElement=function(o){var n=document.createElement("div");n.className=t.clearSelector(s.options.row.item);var i=document.createElement("div");if(i.className=t.clearSelector(s.options.row.text),void 0!==o.link){var r=document.createElement("a");r.setAttribute("href",o.link),r.innerHTML=(o.count>0?"<b>"+o.count+"</b> ":"")+o.title,r.className=t.clearSelector(s.options.row.link),i.appendChild(r)}else{var l=document.createElement("div");l.innerHTML=o.title,l.className=t.clearSelector(s.options.row.link),i.appendChild(l)}return s.options.clickCallback&&"function"==typeof s.options.clickCallback&&(n.addEventListener?n.addEventListener("click",(function(){s.options.clickCallback(this,e(s.options.input,s.form).get(0))}),!1):n.attachEvent("onclick",(function(){s.options.clickCallback(this,e(s.options.input).get(0))}))),n.appendChild(i),n},this.buildNoResults=function(){var e=document.createElement("div");return e.className=t.clearSelector(s.options.no_results),e.innerHTML="No Results",e},this.buildSearchElements=function(t){if(t.items.length){for(var o in t.items){var n=t.items[o],i=s.buildRowElement(n);s.results_container.appendChild(i)}e(s.options.overflow).replaceWith(e(s.options.overflow).contents()),s.results_container.style.display=""}else if(s.options.showNoResults){var r=s.buildNoResults();s.results_container.appendChild(r),e(s.options.overflow).replaceWith(e(s.options.overflow).contents()),s.results_container.style.display=""}},this.processFastSearchAutoFill=function(t){void 0!==s.form.getElementsByClassName("search-autocomplete")&&void 0!==s.form.getElementsByClassName("search-autocomplete")[0]&&(s.form.getElementsByClassName("search-autocomplete")[0].innerHTML="",e.ajax({url:"ajax_content.php",data:"action=get_search_autofill_json&s="+e(t).val(),type:"POST",dataType:"json",success:function(t){e(s.options.input).get(0)&&e(s.options.autocomplete).get(0)&&void 0!==t&&void 0!==t.match&&void 0!==t.autofill&&e(s.options.input,s.form).val().toLowerCase()==t.match.toLowerCase()&&e(s.options.autocomplete,s.form).html(e(s.options.input,s.form).val()+"<span>"+t.autofill+"</span>")}}))},this.init=function(){e(s.options.input).attr("autocomplete","off"),e(s.options.clear_button).removeAttr("onclick"),e(s.options.clear_button).click(s.clearSearchResults),s.assignHandlers()}}return{create:function(e){return new o(e)}}}));